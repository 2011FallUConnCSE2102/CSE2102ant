<?xml version="1.0"?>

<project name="parallel-test" basedir="." default="help">
  <target name="testBasic">
    <parallel>
      <sequential>
        <sleep seconds="1"/>
        <echo message="${test.delayed}"/>
      </sequential>
      <echo message="${test.direct}"/>
    </parallel>
  </target>

  <target name="testFail">
    <parallel>
      <sequential>
        <sleep seconds="1"/>
        <echo message="${test.delayed}"/>
      </sequential>
      <fail message="${test.failure}"/>
    </parallel>
  </target>

  <target name="testThreadCount">
    <parallel threadCount='1' pollInterval="30">
      <!-- expected start 1, end 1, start 2, end 2, start 3, end 3 -->
      <sequential>
        <echo message="+1"/>
        <sleep seconds="1"/>
        <echo message="-1"/>
      </sequential>
      <sequential>
        <echo message="+2"/>
        <sleep seconds="2"/>
        <echo message="-2"/>
      </sequential>
      <sequential>
        <echo message="+3"/>
        <sleep seconds="3"/>
        <echo message="-3"/>
      </sequential>
    </parallel>
    <parallel threadCount='2' pollInterval="30">
      <!-- expected start 1, start 2, end 1, start 3, end 2, end 3 -->
      <sequential>
        <echo message="+1"/>
        <sleep seconds="1"/>
        <echo message="-1"/>
      </sequential>
      <sequential>
        <sleep milliseconds="200"/>
        <echo message="+2"/>
        <sleep seconds="2"/>
        <echo message="-2"/>
      </sequential>
      <sequential>
        <sleep milliseconds="300"/>
        <echo message="+3"/>
        <sleep seconds="3"/>
        <echo message="-3"/>
      </sequential>
    </parallel>
    <parallel threadCount='3' pollInterval="30">
      <!-- expected start 1, start 2, start 3, end 1, end 2, end 3 -->
      <sequential>
        <echo message="+1"/>
        <sleep seconds="1"/>
        <echo message="-1"/>
      </sequential>
      <sequential>
        <sleep milliseconds="200"/>
        <echo message="+2"/>
        <sleep seconds="2"/>
        <echo message="-2"/>
      </sequential>
      <sequential>
        <sleep milliseconds="300"/>
        <echo message="+3"/>
        <sleep seconds="3"/>
        <echo message="-3"/>
      </sequential>
    </parallel>
    <parallel threadCount='4' pollInterval="30">
      <!-- expected start 1, start 2, start 3, end 1, end 2, end 3 -->
      <sequential>
        <echo message="+1"/>
        <sleep seconds="1"/>
        <echo message="-1"/>
      </sequential>
      <sequential>
        <sleep milliseconds="200"/>
        <echo message="+2"/>
        <sleep seconds="2"/>
        <echo message="-2"/>
      </sequential>
      <sequential>
        <sleep milliseconds="300"/>
        <echo message="+3"/>
        <sleep seconds="3"/>
        <echo message="-3"/>
      </sequential>
    </parallel>
    <parallel threadsPerProcessor='1' pollInterval="30">
      <!-- expected result varies, depends on setup -->
      <!-- this is a smoke test for threadsPerProcessor -->
      <sequential>
        <!--echo message="+1"/-->
        <sleep seconds="1"/>
        <!--echo message="-1"/-->
      </sequential>
      <sequential>
        <!--echo message="+2"/-->
        <sleep seconds="2"/>
        <!--echo message="-2"/-->
      </sequential>
      <sequential>
        <!--echo message="+3"/-->
        <sleep seconds="3"/>
        <!--echo message="-3"/-->
      </sequential>
    </parallel>
    
  </target>

  <target name="testDemux">
    <parallel>
      <demuxtest/>
      <demuxtest/>
      <demuxtest/>
      <demuxtest/>
      <demuxtest/>
    </parallel>
  </target>
  
  <target name="help">
    <echo>Test build file for the &lt;parallel&gt; task.</echo> 
    <echo>Use the various targets to run the tests.</echo>
  </target>
</project>
